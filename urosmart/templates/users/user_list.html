{% extends 'base_afterlogin.html' %}
{%block style%}
.message {
    color: red;
    text-align: center;
    margin-bottom: 10px;
}
{%endblock%}
{% block content %}
<div class="container my-4">
    <h2 >å¸³è™Ÿç®¡ç†</h2>
    {% if messages %}
            {% for message in messages %}
                <div class="message">{{ message }}</div>
            {% endfor %}
    {% endif %}
    <!-- ğŸ” æœå°‹æ¬„ä½ -->
    <div class="row mb-3">
        <div class="col-md-6 offset-md-3">
            <input type="text" id="searchInput" class="form-control" placeholder="æœå°‹ä½¿ç”¨è€…...">
        </div>
    </div>

    <!-- ä½¿ç”¨è€…æ¸…å–® -->
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="thead-light">
                <tr>
                    <th>å¸³è™Ÿ</th>
                    <th>å§“å</th>
                    <th>å“¡å·¥ç·¨è™Ÿ</th>
                    <th>Email</th>
                    <th>å–®ä½</th>
                    <th>è§’è‰²</th>
                    {% comment %} <th>æ¬Šé™</th> {% endcomment %}
                    <th>ç‹€æ…‹</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
                {% for user in users %}
                <tr>
                    <td>{{ user.username }}</td>
                    <td>{{ user.first_name }} {{ user.last_name }}</td>
                    <td>{{ user.employee_id }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.department }}</td>
                    <td>{{ user.get_role_display }}</td>
                    {% comment %} <td>{{ user.get_permission_display }}</td> {% endcomment %}

                    <!-- ğŸ”„ å•Ÿç”¨/åœç”¨æŒ‰éˆ• -->
                    <td>
                        {% comment %} <button 
                            class="btn btn-sm {% if user.status == 'active' %}btn-success{% else %}btn-danger{% endif %}" 
                            onclick="toggleStatus({{ user.id }})"
                            id="status-btn-{{ user.id }}">
                            {% if user.status == 'active' %}å•Ÿç”¨{% else %}åœç”¨{% endif %}
                        </button> {% endcomment %}
                        <button
                            class="btn btn-sm {% if user.is_active %}btn-success{% else %}btn-danger{% endif %}"
                            data-toggle-url="{% url 'toggle_user_status' user.id %}"
                            onclick="toggleStatus(this)"
                            id="status-btn-{{ user.id }}">
                            {%if user.is_active%}å•Ÿç”¨ {%else%} åœç”¨ {%endif%}
                        </button>
                    </td>

                    <td>
                        <a href="{% url 'user_detail' user.id %}" class="btn btn-primary btn-sm">ç·¨è¼¯</a>
                        <a href="{% url 'user_delete' user.id %}" 
                           onclick="return confirm('ç¢ºå®šåˆªé™¤å—?');" 
                           class="btn btn-danger btn-sm">åˆªé™¤</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" class="text-center text-muted">ç›®å‰æ²’æœ‰å¸³è™Ÿè³‡æ–™</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- æ–°å¢å¸³è™ŸæŒ‰éˆ• -->
    <div class="text-center mt-4">
        <a href="{% url 'user_create' %}" class="btn btn-success">æ–°å¢å¸³è™Ÿ</a>
    </div>
</div>

<!-- AJAX åˆ‡æ›å•Ÿç”¨/åœç”¨ -->
<script>
{% comment %} function toggleStatus(userId) {
    fetch(`/toggle_user_status/${userId}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    })
    .then(response => response.json())
    .then(data => {
        const btn = document.getElementById(`status-btn-${userId}`);
        if (data.status === 'active') {
            btn.className = 'btn btn-sm btn-success';
            btn.innerText = 'å•Ÿç”¨';
        } else {
            btn.className = 'btn btn-sm btn-danger';
            btn.innerText = 'åœç”¨';
        }
    })
    .catch(error => console.error('Error:', error));
} {% endcomment %}
function toggleStatus(btn) {
    const url = btn.dataset.toggleUrl;          // â† å®Œæ•´è·¯å¾‘
    fetch(url, {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
    })
    .then(r => r.json())
    .then(data => {
         // data.is_active æ˜¯ true / false
      if (data.is_active) {
        btn.className  = "btn btn-sm btn-success";
        btn.textContent = "å•Ÿç”¨";
        } else {
        btn.className  = "btn btn-sm btn-danger";
        btn.textContent = "åœç”¨";
        }
    })
    .catch(err => console.error(err));
  }

// æœå°‹åŠŸèƒ½
document.getElementById('searchInput').addEventListener('keyup', function() {
    const searchValue = this.value.toLowerCase();
    const rows = document.getElementById('userTableBody').getElementsByTagName('tr');

    for (let row of rows) {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(searchValue) ? '' : 'none';
    }
});
</script>
{% endblock %}
